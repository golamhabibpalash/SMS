@model IEnumerable<SMS.App.ViewModels.ExamResult.ExaminationResultVM>
@using System.Globalization;
@{
    int sl = 0;
    bool isHeader = false;
    List<string> subjectNames = new List<string>();
    if (Model != null)
    {
        subjectNames = Model
                    .SelectMany(result => result.ExaminationResultDetailsVMs.Select(detail => detail.SubjectName))
                    .Distinct()
                    .ToList();
    }
    bool isImrove = true;
    string studentNameTitleCase = string.Empty;
}
@section Styles{ 
    <style>
        .loading-container
        {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            min-height:700px;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display:none;
        }
        .loadingimage img
        {
            max-width: 50%;
            max-height: 50%;
        }
    </style>
}
<div class="row">
    <div class="col-md-12">
        <form asp-action="ClassWiseResult" asp-controller="ExamResults" method="post">
            <div class="form-row">
                <div class="col-md-2">
                    <select class="form-control" asp-items="ViewBag.ExamGroupList" name="examGroupId" id="examGroupId">
                        <option selected disabled>Select Exam Group</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-control" asp-items="ViewBag.AcademicClassList" name="classId" id="AcademicClassId">
                        <option selected disabled>Select Academic Class</option>
                    </select>
                </div>
                <div>
                    <input type="submit" class="btn btn-info btn-sm" value="Search" onclick="reloadData()">
                </div>
            </div>
        </form>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        @if (Model != null)
        {
            <table class="table table-responsive table-hover table-bordered" id="myTable">
                <thead>
                    <tr>
                        <th id="headerTh">
                            <div class="col-md-4 text-md-right">
                                <img src="~/Images/Institute/@ViewBag.logo" alt="Alternate Text" style="max-width:100px;" />
                            </div>
                            <div class="col-md-8">
                                <h3 class="h3 font-weight-bolder"> @ViewBag.InstituteName</h3>
                                <h6>@ViewBag.ExamGroupName</h6>
                                <h5>@ViewBag.academicClassName</h5>
                            </div>

                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var exam in Model)
                    {
                        @if (!isHeader)
                        {
                            <tr class="table-info align-middle" id="headerTr">
                                <td class="align-middle">#</td>
                                <td class="align-middle">Class Roll</td>
                                <td class="align-middle">Student Name</td>
                                @foreach (var exDetail in exam.ExaminationResultDetailsVMs)
                                {
                                    <td class="p-0 m-0">
                                        <table class="w-100">
                                            <tr>
                                                <td colspan="3" class="text-nowrap text-center">@exDetail.SubjectName <br />(Highest @exDetail.HighestObtainMark of @exDetail.ExamMarks)</td>
                                            </tr>
                                            <tr>
                                                <td>Marks</td>
                                                <td>GPA</td>
                                                <td>Grade</td>
                                            </tr>
                                        </table>
                                    </td>
                                }
                                <td class="align-middle">Total Marks</td>
                                <td class="align-middle">CGPA</td>
                                <td class="align-middle">Grade</td>
                                <td class="align-middle">Status</td>
                                <td class="align-middle">Fail/s</td>
                                <td class="align-middle">Attendance %</td>
                                <td class="align-middle">Rank</td>
                                <td class="align-middle">Previous Rank</td>
                            </tr>
                        }
                <tr class="align-middle text-center">
                    <td>@(++sl).</td>
                    <td> @exam.ClassRoll </td>
                    @{ 
                        TextInfo textInfo = new CultureInfo("en-US", false).TextInfo;
                        studentNameTitleCase = textInfo.ToTitleCase(exam.StudentName);
                    }
                    <td class="text-nowrap text-left">@studentNameTitleCase</td>

                    @if (exam.ExaminationResultDetailsVMs != null)
                    {
                        foreach (var exDetail in exam.ExaminationResultDetailsVMs)
                        {
                            <td class="p-0 m-0 align-bottom parentTd">
                                <table class="w-100 h-100 innerTable">
                                    <tr>
                                        <td style="width:35%" class="childTd">@exDetail.ObtainMarks</td>
                                        <td style="width:33%" class="childTd">@exDetail.ObtainPoint</td>
                                        <td style="width:32%" class="childTd">@exDetail.ObtainGrade</td>
                                    </tr>
                                </table>
                            </td>
                        }
                    }
                    <td>@exam.TotalMarks</td>
                    <td>@exam.CGPA.ToString("0.00")</td>
                    <td>@exam.Grade</td>
                    <td>@exam.GradeComment</td>
                    <td>@exam.FailSubCount</td>
                    <td>@exam.AttendancePercent</td>
                    
                    <td>
                        @exam.Rank
                                        @if (exam.Rank < exam.PreviousMonthRank)
                                        {
                                            <i class="fas fa-level-up text-success"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-level-down text-warning"></i>
                                        }
                                    </td>
                    <td>@exam.PreviousMonthRank</td>
                </tr>

                        isHeader = true;
                    }
                </tbody>
                <tfoot>

                </tfoot>
            </table>

        }

    </div>
</div>


<div id="loadingContainer" class="loading-container" @(ViewBag.IsLoading ? "style='display:block;'" : "style='display:none;'")>
    <div id="loadingImage" class="loadingImage text-center" style="display: none; margin-top:20%; text-align:center;vertical-align:central">
        <img style="width:25%;" src="~/Images/loading1.gif" alt="Loading..." />
    </div>
</div>

@section Scripts{
    <script src="~/js/AlertifyNotify/AlertifyNofify.js"></script>

    <script>
        let dataLoaded = false;
        $(document).on("dataLoaded", function () {
            // Set the flag variable to true.
            dataLoaded = true;
        });

        function showLoadingImage() {
            document.getElementById("loadingImage").style.display = "block";
            $("#loadingContainer").fadeIn(200);
            document.getElementById("myTable").style.display = "none";

        }

        function hideLoadingImage() {
            document.getElementById("loadingImage").style.display = "none";
            $("#loadingContainer").fadeOut(200);
            document.getElementById("myTable").style.display = "block";
        }

        // Example function to simulate data reloading
        function reloadData() {
            showLoadingImage();
            // Perform your data reloading here
            if (dataLoaded) {
                hideLoadingImage();
            }
            // Simulate a delay to show the loading image (remove this in production)
            //setTimeout(function () {
            //    hideLoadingImage();
            //    // Update your data on the page
            //},3000); // 2 seconds delay for demonstration
        }
    </script>
    <script>
        // Wait for the DOM to be fully loaded
        document.addEventListener("DOMContentLoaded", function () {
           
            //Code for Table Header/Heading
            // Get the <th> and <tr> elements
            var headerTh = document.getElementById("headerTh");
            var headerTr = document.getElementById("headerTr");

            // Calculate the number of <td> elements
            var tdCount = headerTr.getElementsByTagName("td").length;

            // Set the rowspan attribute of <th>
            headerTh.setAttribute("colspan", tdCount);



            // Get the <td> elements within the table
            var tdElements = document.querySelectorAll("#myTable td");

            // Iterate through each <td> element
            tdElements.forEach(function (td) {
                // Check if inner text is 'F'
                if (td.innerText.trim() === "F") {
                    // Set background color to 'salmon'
                    td.style.backgroundColor = "salmon";
                }
            });
        });

        $(document).ready(function () {
            $('#examGroupId').change(function () {
                let id = $('#examGroupId option:selected').val();
                $.ajax({
                    url: "/AcademicExams/GetAcademicClassByExamGrId?examGroupId=" + id,
                    dataType: "JSON",
                    type: "POST",
                    cache: false,
                    success: function (data) {
                        $('#AcademicClassId').empty();
                        var o = '<option disabled selected>Select Class</option>';
                        $('#AcademicClassId').append(o);
                        $.each(data, function (i, obj) {
                            console.log(obj.name);
                            var op = '<option value="' + obj.id + '">' + obj.name + '</option>';
                            $('#AcademicClassId').append(op);
                        });
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            });
        });
    </script>
}