@using Microsoft.AspNetCore.Identity

@model SMS.App.ViewModels.Students.StudentDetailsVM


@inject UserManager<ApplicationUser> _userManager;

@{
    var user = await _userManager.GetUserAsync(User);
    if (user.UserType == 's')
    {
        Layout = "~/Views/Shared/_StudentLayout.cshtml";
    }
    string createdBy = string.Empty;
}

@{
    string stuName = Model.Student.Name;
    ViewData["Title"] = "Student Details";
    GlobalUI.PageTitle = stuName + " Detail Informations";

    //age calculation
    int now = int.Parse(DateTime.Now.ToString("yyyyMMdd"));
    int dob = int.Parse(Model.Student.DOB.ToString("yyyyMMdd"));
    int age = (now - dob) / 10000;
    string phonePrefix = "+880";
    int paySL = 0;
    double totalPaid = 0;
    //double currentDue = 0;
    //double totalDue = 0;
    int paymentScheduleSL = 1;
    //double paymentScheduleSubTotal = 0.0;
    double paymentScheduleTotal = 0.0;
    int paymentSchedulePaidSL = 1;
    double paidScheduleTotal = 0.0;
    DateTime todate = new DateTime(DateTime.Now.Year, 1, 1);
    string fileName = Model.Student.ClassRoll + "_Payment_Report_" + DateTime.Now.ToString("dd-MM-yyyy");
    //int attSl = 0;
}
@section Styles{
    <style>
        .table th, .table td
        {
            padding: 0.25rem;
        }

        #academic table td:first-child
        {
            text-align: right
        }

        .nav-tabs .nav-item.show .nav-link, .nav-tabs .nav-link.active{
            color:black !important;
        }

    </style>
}

<div class="row p-2">
    <div class="col-md-3 bg-navy-blue mh-100 rounded">
        <div class="row pt-2">
            <div class="col-md-12 text-center">
                @if (string.IsNullOrEmpty(Model.Student.Photo))
                {
                    <img class="rounded-circle" src="~/Images/Student/noimage.jpg" alt="Student Photo" onerror="this.src='@Url.Content("~/Images/Student/noimage.jpg")'" style="width:40%;" />
                }
                else
                {
                    <img class="rounded-circle" src="~/Images/Student/@Model.Student.Photo" alt="Student Photo" onerror="this.src='@Url.Content("~/Images/Student/noimage.jpg")'" style="width:40%;" />
                }
            </div>
        </div>
        <div class="row text-light">
            <div class="col-md-12">
                <dl class="row p-2">
                    <dt class="col-sm-4 col-4 text-md-right text-sm-right text-right">
                        Name :
                    </dt>
                    <dd class="col-sm-8 col-8 border-bottom">
                        @Html.DisplayFor(model => model.Student.Name)
                    </dd>
                    <dt class="col-sm-4 col-4 text-md-right text-sm-right text-right">
                        নাম (বাংলা) :
                    </dt>
                    <dd class="col-sm-8 col-8 border-bottom">
                        @Html.DisplayFor(model => model.Student.NameBangla)
                    </dd>
                    <dt class="col-sm-4 col-4 text-md-right text-sm-right text-right">
                        Session :
                    </dt>
                    <dd class="col-sm-8 col-8 border-bottom">
                        @Html.DisplayFor(model => model.Student.AcademicSession.Name)
                    </dd>
                    <dt class="col-sm-4 col-4 text-md-right text-sm-right text-right">
                        Class :
                    </dt>
                    <dd class="col-sm-8 col-8 border-bottom">
                        @Html.DisplayFor(model => model.Student.AcademicClass.Name)
                    </dd>
                    <dt class="col-sm-4 col-4 text-md-right text-sm-right text-right">
                        Section :
                    </dt>
                    <dd class="col-sm-8 col-8 border-bottom">
                        @if (Model.Student.AcademicSectionId != null)
                        {
                            @Html.DisplayFor(model => model.Student.AcademicSection.Name)
                        }
                        else
                        {
                            <span>No Section</span>
                        }
                    </dd>
                    <dt class="col-sm-4 col-4 text-md-right text-sm-right text-right">
                        Roll :
                    </dt>
                    <dd class="col-sm-8 col-8 border-bottom">
                        @Html.DisplayFor(model => model.Student.ClassRoll)
                    </dd>
                    <dt class="col-sm-4 col-4 text-md-right text-sm-right text-right">
                        Admission Date :
                    </dt>
                    <dd class="col-sm-8 col-8 border-bottom">
                        @Model.Student.AdmissionDate.ToString("dd MMM yyyy")
                    </dd>
                </dl>
            </div>
        </div>
    </div>
    <div class="col-md-9 bg-light mh-100 shadow-lg">
        <div class="card text-center">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="bologna-list">
                    <li class="nav-item bg-navy-blue text-light border">
                        <a class="nav-link text-warning active" href="#personal" id="personalTab" role="tab" aria-controls="personal" aria-selected="true">Personal Information</a>
                    </li>
                    <li class="nav-item bg-navy-blue border">
                        <a class="nav-link text-warning" href="#academic" role="tab" aria-controls="academic" aria-selected="true">Academic Information</a>
                    </li>
                    <li class="nav-item bg-navy-blue border">
                        <a class="nav-link text-warning" role="tab" aria-controls="financials" aria-selected="true" href="#financials">Student Financials</a>
                    </li>
                    <li class="nav-item bg-navy-blue border">
                        <a class="nav-link text-warning" role="tab" aria-controls="attendance" aria-selected="true" href="#attendance">Attendance</a>
                    </li>
                    <li class="nav-item bg-navy-blue border">
                        <a class="nav-link text-warning" role="tab" aria-controls="results" aria-selected="true" href="#results">Results</a>
                    </li>
                    <li class="nav-item bg-navy-blue border">
                        <a class="nav-link text-warning" role="tab" aria-controls="documents" aria-selected="true" href="#documents">Documents</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <div id="personal" class="tab-pane active text-left" role="tabpanel">
                        <table class="table border-0 table-borderless table-responsive" style="height:100%;">
                            <thead>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Student Name</td>
                                    <td>:</td>
                                    <td>@Model.Student.Name</td>
                                </tr>
                                <tr>
                                    <td>Gender</td>
                                    <td>:</td>
                                    <td>@Model.Student.Gender.Name</td>
                                </tr>
                                <tr>
                                    <td>Date of Birth</td>
                                    <td>:</td>
                                    <td>@Model.Student.DOB.ToString("dd MMM yyyy") (@age years)</td>
                                </tr>
                                <tr>
                                    <td>Nationality</td>
                                    <td>:</td>
                                    <td>@Model.Student.Nationality.Name</td>
                                </tr>
                                <tr>
                                    <td>Religion</td>
                                    <td>:</td>
                                    <td>@Model.Student.Religion.Name</td>
                                </tr>
                                <tr>
                                    <td>Blood Group</td>
                                    <td>:</td>
                                    @if (Model.Student.BloodGroupId != null)
                                    {
                                        <td>@Model.Student.BloodGroup.Name</td>
                                    }
                                    else
                                    {
                                        <td>Not Provided</td>
                                    }
                                </tr>
                                <tr class="bg-navy-blue">
                                    <td class="p-1" colspan="3">
                                        <span class="font-weight-bold p-2">Contact Information</span>
                                    </td>
                                </tr>

                                <tr>
                                    <td>Phone</td>
                                    <td>:</td>
                                    <td>@phonePrefix@Model.Student.PhoneNo</td>
                                </tr>
                                <tr>
                                    <td>Email</td>
                                    <td>:</td>
                                    <td>@Model.Student.Email</td>
                                </tr>
                                <tr class="bg-navy-blue">
                                    <td colspan="3" class="p-1">
                                        <span class="font-weight-bold p-2">Guardians Information</span>
                                    </td>
                                </tr>

                                <tr>
                                    <td>Father's Name</td>
                                    <td>:</td>
                                    <td>@Model.Student.FatherName</td>
                                </tr>
                                <tr>
                                    <td>Mother's Name</td>
                                    <td>:</td>
                                    <td>@Model.Student.MotherName</td>
                                </tr>
                                <tr>
                                    <td>Guardian's Phone</td>
                                    <td>:</td>
                                    <td>@phonePrefix@Model.Student.GuardianPhone</td>
                                </tr>
                                <tr class="bg-navy-blue">
                                    <td colspan="3" class="p-1">
                                        <span class="font-weight-bold p-2">Address Information</span>
                                    </td>
                                </tr>

                                <tr>
                                    <td>Present Address</td>
                                    <td>:</td>
                                    <td>Vill/Area - @Model.Student.PresentAddressArea, Post Office - @Model.Student.PresentAddressPO, Polic Station - @Model.Student.PresentUpazila.Name, @Model.Student.PresentDistrict.Name</td>
                                </tr>
                                <tr>
                                    <td>Permanent Address</td>
                                    <td>:</td>
                                    <td>Vill/Area - @Model.Student.PermanentAddressArea, Post Office - @Model.Student.PermanentAddressPO, Polic Station - @Model.Student.PermanentUpazila.Name, @Model.Student.PermanentDistrict.Name</td>
                                </tr>
                                @if (!string.IsNullOrEmpty(Model.Student.AddressInfo))
                                {
                                    <tr>
                                        <td>Address Information:</td>
                                        <td>:</td>
                                        <td>@Model.Student.AddressInfo</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                    <div id="academic" class="tab-pane" role="tabpanel">
                        <div>
                            <table class="table table-responsive">
                                <tbody class="text-left">
                                    <tr>
                                        <td>Name</td>
                                        <td>:</td>
                                        <td>@Model.Student.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Name (নাম)</td>
                                        <td>:</td>
                                        <td>@Model.Student.NameBangla</td>
                                    </tr>
                                    <tr>
                                        <td>Session</td>
                                        <td>:</td>
                                        <td>@Model.Student.AcademicSession.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Class</td>
                                        <td>:</td>
                                        <td>@Model.Student.AcademicClass.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Class Roll</td>
                                        <td>:</td>
                                        <td>@Model.Student.ClassRoll</td>
                                    </tr>
                                    <tr>
                                        <td>Section</td>
                                        <td>:</td>
                                        <td>
                                            @if (Model?.Student != null && Model.Student.AcademicSection != null)
                                            {
                                                @Model.Student.AcademicSection.Name
                                            }
                                            else
                                            {
                                                <text>N/A</text>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Admission Date</td>
                                        <td>:</td>
                                        <td>@Model.Student.AdmissionDate.ToString("dd MMM yyyy")</td>
                                    </tr>
                                    <tr>
                                        <td>Blood Group</td>
                                        <td>:</td>
                                        <td>@Model.Student.BloodGroup.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Gender</td>
                                        <td>:</td>
                                        <td>@Model.Student.Gender.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Nationality</td>
                                        <td>:</td>
                                        <td>@Model.Student.Nationality.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Religion</td>
                                        <td>:</td>
                                        <td>@Model.Student.Religion.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Birth Certificate</td>
                                        <td>:</td>
                                        @if (string.IsNullOrEmpty(Model.Student.BirthCertificateNo))
                                        {
                                            <td>
                                                N/A
                                            </td>
                                        }
                                        else
                                        {
                                            <td>
                                                @Model.Student.BirthCertificateNo
                                            </td>

                                        }
                                    </tr>
                                    <tr>
                                        <td>Previous School</td>
                                        <td>:</td>
                                        @if (string.IsNullOrEmpty(Model.Student.PreviousSchool))
                                        {
                                            <td>
                                                N/A
                                            </td>
                                        }
                                        else
                                        {
                                            <td>
                                                @Model.Student.PreviousSchool
                                            </td>

                                        }
                                    </tr>
                                    <tr>
                                        <td>Residential</td>
                                        <td>:</td>
                                            @if (Model.Student.IsResidential)
                                            {
                                                <td>Residential</td>
                                            }
                                            else
                                            {
                                                <td>Non Residential</td>
                                            }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="financials" class="tab-pane" role="tabpanel">
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <div class="card p-0 shadow">
                                    <div class="card-header bg-info">
                                        <spn class="card-title h4 font-weight-bold text-light">Payment Schedule</spn>
                                    </div>
                                    <div class="card-body p-0">
                                        @if (Model.StudentPaymentSchedules != null)
                                        {
                                            <table class="table pb-0 mb-0">
                                                <thead class="table-info">
                                                    <tr>
                                                        <td>#</td>
                                                        <td>Payment Type</td>
                                                        <td>Amount</td>
                                                        <td class="text-right">Total</td>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model.StudentPaymentSchedules.OrderBy(s => s.PaymentType))
                                                    {
                                                        <tr>
                                                            <td>@(paymentScheduleSL++)</td>
                                                            <td>@item.PaymentType</td>
                                                            <td>@item.Amount <span class="badge badge-pill badge-warning">@item.yearlyFrequency</span></td>
                                                            <td class="text-right">@(item.Amount * item.yearlyFrequency)</td>
                                                        </tr>
                                                        paymentScheduleTotal += item.Amount * item.yearlyFrequency;
                                                    }
                                                </tbody>
                                                <tfoot class="bg-info text-light">
                                                    <tr class="font-weight-bolder">
                                                        <td colspan="3">Total</td>
                                                        <td class="text-right">@paymentScheduleTotal</td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 ">
                                <div class="card p-0 shadow">
                                    <div class="card-header bg-info">
                                        <span class="card-title h4 font-weight-bold text-light">Schedule wise paid</span>
                                    </div>
                                    <div class="card-body p-0">
                                        @if (Model.StudentPaymentSchedulePaidVMs.Count > 0 && Model.StudentPaymentSchedulePaidVMs != null)
                                        {
                                            <table class="table pb-0 mb-0">
                                                <thead class="table-info">
                                                    <tr>
                                                        <td>#</td>
                                                        <td>Payment Type</td>
                                                        <td class="text-right">Amount</td>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model.StudentPaymentSchedulePaidVMs.OrderBy(s => s.PaymentType))
                                                    {
                                                    <tr>
                                                        <td>@(paymentSchedulePaidSL++)</td>
                                                        <td>@item.PaymentType</td>
                                                        <td class="text-right">@item.PaidAmount</td>
                                                    </tr>
                                                        paidScheduleTotal += item.PaidAmount;
                                                    }
                                                </tbody>
                                                <tfoot class="bg-info">
                                                    <tr class="font-weight-bolder text-light">
                                                        <td colspan="2">Total</td>
                                                        <td class="text-right">@paidScheduleTotal</td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="row pl-2 pr-2">
                            <div class="col-md-12 bg-navy-blue well">
                                <div class="">
                                    <div class="col-md-6 text-left">
                                        <h5 class="h5 text-light">Current Due Amount : <span class="text-warning font-weight-bolder">@Model.CurrentDue tk</span></h5>
                                        <h5 class="h5 text-light">Total Due Amount : <span class="text-warning font-weight-bolder">@Model.TotalDue tk</span></h5>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <a asp-action="Payment" asp-controller="StudentPayments" asp-route-stRoll="@Model.Student.ClassRoll" class="btn btn-warning text-primary font-weight-bolder">Make Payment</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-10">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="text-center">
                                            <span class="h4 font-weight-bold">Payment History</span>
                                        </div>
                                    </div>
                                    <div class="">
                                        <table class="table table-hover table-bordered table-responsive-sm mb-0">
                                            <thead class="bg-blue-sky">
                                                <tr>
                                                    <td>#</td>
                                                    <td>Receipt No</td>
                                                    <td>Paid For</td>
                                                    <td>Payment Date</td>
                                                    <td class="text-right">Amount</td>
                                                    <td>Remarks</td>
                                                    <td>Received By</td>
                                                    <td>Received Date</td>
                                                    @*<td>Action</td>*@
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var payment in Model.StudentPayments.OrderBy(d => d.PaidDate))
                                                {
                                                    foreach (var pDetails in payment.StudentPaymentDetails)
                                                    {
                                                        if (pDetails.CreatedBy!=null)
                                                        {
                                                            ApplicationUser aUser = await _userManager.FindByIdAsync(pDetails.CreatedBy);
                                                            createdBy = aUser.UserName;
                                                        }
                                                        <tr>
                                                            <td>@(++paySL)</td>
                                                            <td>@payment.ReceiptNo</td>
                                                            <td>@pDetails.StudentFeeHead.Name</td>
                                                            <td>@payment.PaidDate.ToString("dd MMM yyyy")</td>
                                                            <td class="text-right">@payment.TotalPayment</td>
                                                            <td>@payment.Remarks</td>
                                                            <td>@createdBy</td>
                                                            <td class="text-md-left">@payment.CreatedAt.ToString("dd MMM yyyy")</td>
                                                        </tr>
                                                    }
                                                    totalPaid += payment.TotalPayment;
                                                }
                                            </tbody>
                                            <tfoot class="bg-blue-sky">
                                                <tr>
                                                    <td colspan="4" class="text-right">Total Paid</td>

                                                    <td class="text-right font-weight-bolder">@totalPaid</td>
                                                    <td colspan="3" class="text-left">Tk</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <div class="card-footer">
                                        <div class="text-center">
                                            <span class="h6 font-weight-bold text-black-50">Total Paid : @totalPaid tk</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2" style="display:flex;flex-direction:column;justify-content:center">
                                <div>
                                    <a class="btn btn-warning p-4 font-weight-bolder btn-outline-info" asp-action="StudentPaymentInfoExport" asp-controller="Reports" asp-route-reportType="pdf" asp-route-fileName="@fileName" asp-route-classRoll="@Model.Student.ClassRoll" asp-route-fromDate="@todate.ToString("dd-MM-yyyy")" asp-route-toDate="@DateTime.Today.ToString("dd-MM-yyyy")" target="_blank">
                                        <span class="fa fa-file"></span> Get Report
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="attendance" class="tab-pane">
                        @foreach (var item in Model.AttendanceDetails)
                        {
                            <div class="col-md-3 card p-0 m-1">
                                <div class="card-header p-1">
                                <h6>Month: @item.MonthName</h6> 
                                </div>
                                <div class="card-body p-1">
                                    <table>
                                        <tr>
                                            <td class="text-left">Total Attended</td>
                                            <td>:</td>
                                            <td class="text-left">@item.AttendanceCount (@item.TotalDays) Days</td>
                                        </tr>
                                        <tr>
                                            <td class="text-left">Attendance Percentage</td>
                                            <td>:</td>
                                            <td class="text-left">@item.PresentPercentage%</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="card-footer p-0 text-left">
                                    <span class="bg-success p-1 text-center text-light" style="display:block; width:@item.PresentPercentage%">@item.PresentPercentage%</span>                                   
                                </div>
                            </div>


                        }


                    </div>
                    <div id="results" class="tab-pane">
                        <div class="text-center">
                            <h4 class="text-danger">This page is under construction</h4>
                        </div>
                        
                    </div>
                    <div id="documents" class="tab-pane">
                        <div class="text-center">
                            <h4 class="text-danger">This page is under construction</h4>
                        </div>
                        All Documents will go here
                    </div>
                </div>
            </div>
        </div>
    </div>
    @if (User.IsInRole("Admin") || User.IsInRole("SuperAdmin"))
    {
        <div class="col-md-10 offset-1  p-1 mb-2">
            <div class="row p-2">
                <div class="col-md-12 text-center">
                    <partial name="_Edit_Back" model="@Model.Student.Id" />
                </div>
            </div>
        </div>
    }
</div>



@section Scripts{
    <script>
        $(document).ready(function () {
            $('#bologna-list a').on('click', function (e) {
                e.preventDefault()
                $(this).tab('show')
            });
        });

        let tabName = '@ViewBag.tabName';
        if (tabName != '') {
            let personal = document.getElementById('personal');
            let academic = document.getElementById('academic');
            let financials = document.getElementById('financials');
            let attendance = document.getElementById('attendance');
            let result = document.getElementById('results');
            let documents = document.getElementById('documents');

            personal.classList.remove('active');
            academic.classList.remove('active');
            financials.classList.remove('active');
            attendance.classList.remove('active');
            result.classList.remove('active');
            documents.classList.remove('active');

            // Get an element by its 'aria-controls' attribute
            var personalTab = document.querySelector('[aria-controls="personal"]');
            var academicTab = document.querySelector('[aria-controls="academic"]');
            var financialsTab = document.querySelector('[aria-controls="financials"]');
            var attendanceTab = document.querySelector('[aria-controls="attendance"]');
            var resultsTab = document.querySelector('[aria-controls="results"]');
            var documentsTab = document.querySelector('[aria-controls="documents"]');

            personalTab.classList.remove('active');
            academicTab.classList.remove('active');
            financialsTab.classList.remove('active');
            attendanceTab.classList.remove('active');
            resultsTab.classList.remove('active');
            documentsTab.classList.remove('active');

            if (tabName == 'financials') {
                financials.classList.add('active');
                financialsTab.classList.add('active');
            }
        }
    </script>
}