@inject IDesignationManager _designationManager
@inject IAcademicClassManager _academicClassManager
@inject IAcademicSessionManager _academicSessionManager
@inject UserManager<ApplicationUser> _userManger

@model IEnumerable<SMS.App.ViewModels.AttendanceVM.AttendanceMachineIndexVM>

@{
    ViewData["Title"] = "Attendances";
    GlobalUI.PageTitle = ViewBag.Title;

    int sl = 0;
    var designationList = await _designationManager.GetAllAsync();
    var academicClassList = await _academicClassManager.GetAllAsync();
    var academicSessionList = await _academicSessionManager.GetAllAsync();
    string datetime = "";

    @if (ViewBag.attendanceDate != null)
    {
        datetime = DateTime.Now.Date.ToString("dd MMM yyyy");
    }
    else
    {
        datetime = ViewBag.attendanceDate;
    }
    int total = 0;
    if (Model.Count() > 0)
    {
        total = Model.Count();
    }
}

@section Styles{
    <style type="text/css">
        @@page
        {
            size: A4 portrait;
        }

        @@media screen
        {
            #heading_part
            {
                display: none;
            }
        }

        @@media print
        {
            body *
            {
                visibility: hidden;
            }

            #printable_area *
            {
                visibility: visible;
            }

            #printable_area
            {
                position: absolute;
                top: 20px;
                left: 15px;
                right: 15px;
                width: 98%;
            }

            #searching_div, #myTable_length, #myTable_filter, #myTable_paginate
            {
                display: none;
            }

            #myTable *
            {
                border: 1px solid #000;
            }

            .tableBody_last_td, .tableBody_last_td *, #tableHead_last_th, #tableHead_last_th *, .body_machine_no, .body_machine_no *, #head_machine_no
            {
                display: none;
            }

            #heading_part
            {
                display: block;
            }
        }
    </style>
}
<div id="heading_part">
    <div class="row">
        <div class="col-md-12 text-center">
            <h3>Noble Residential School</h3>
            <h4 class="border-bottom text-dark">(@ViewBag.attendanceFor Attendance Sheet)</h4>
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-md-left">Date: @datetime</h6>
                </div>
                <div class="col-md-6">
                    <h6 class="text-md-right">Total: @total</h6>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row" id="searching_div">
    <div class="col-md-12 p-4">
        <form asp-action="index" asp-controller="AttendanceMachines" method="get">
            <div class="form-group row">
                <div class="col-md-2 mb-2">
                    <select class="form-control" name="userType" id="userTypeId">
                        <option selected disabled>User Type</option>
                        <option value="e">Employee</option>
                        <option value="s">Student</option>
                    </select>
                </div>

                <div class="col-md-2 designationArea" style="display:none">
                    <select class="form-control mb-2" name="designationId">
                        <option selected disabled>Select Designation</option>
                        @foreach (Designation designation in designationList)
                        {
                            <option value="@designation.Id">@designation.DesignationName</option>
                        }
                    </select>
                </div>

                <div class="col-md-2 sessionArea" style="display:none">
                    <select class="form-control mb-2" name="sessionId">
                        <option selected disabled>Select Session</option>
                        @foreach (AcademicSession session in academicSessionList)
                        {
                            <option value="@session.Id">@session.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-2 classArea" style="display:none">
                    <select class="form-control mb-2" name="classId">
                        <option selected disabled>Select Class</option>
                        @foreach (AcademicClass academicClass in academicClassList)
                        {
                            <option value="@academicClass.Id">@academicClass.Name</option>

                        }
                    </select>
                </div>

                <div class="col-md-2 dateArea mb-2">
                    <input type="date" class="form-control" name="dateTime" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-md-2">
                    <select class="form-control mb-2" name="attendanceType" id="attendanceType">
                        <option selected disabled>Select Attendance Type</option>
                        <option class="btn-sm btn-info" value="attended">Attended</option>
                        <option class="btn-sm btn-danger" value="absent">Absent</option>
                    </select>
                </div>

                <div class="col-md-2" id="submitArea">
                    <input class="btn-info btn-sm" value="Search" type="submit" />
                    <button class="btn-outline-warning btn-sm" onclick="window.print()"><i class="fa fa-print"></i></button>
                </div>
            </div>
        </form>
    </div>
</div>
@if (Model.Count() > 0)
{
    <table class="table table-responsive-sm table-striped table-hover shadow" id="myTable">
        @if (ViewBag.attendanceFor == "Students")
        {
            <thead>
                <tr>
                    <th>
                        #
                    </th>
                    <th>
                        Student Name
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.CardNo)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.GuardianPhone)
                    </th>
                    <th>
                        Attendance
                    </th>
                    <th>
                        Time
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.UserInfo)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.Remarks)
                    </th>
                    <th id="tableHead_last_th">
                        @if (User.IsInRole("Admin") || User.IsInRole("SuperAdmin"))
                        {
                            <partial name="_create" />
                        }
                        else
                        {
                            <span>Action</span>
                        }
                    </th>
                </tr>
            </thead>
        }
        else
        {
            <thead>
                <tr>
                    <th>
                        #
                    </th>
                    <th>
                        Employee Name
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.Designation)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.Phone)
                    </th>
                    <th>
                        Attendance
                    </th>
                    <th>
                        Time
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.UserInfo)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.Remarks)
                    </th>
                    <th id="tableHead_last_th">
                        @if (User.IsInRole("Admin") || User.IsInRole("SuperAdmin"))
                        {
                            <partial name="_create" />
                        }
                        else
                        {
                            <span>Action</span>
                        }
                    </th>
                </tr>
            </thead>
        }


        <tbody>
            @foreach (var item in Model.DistinctBy(m => m.CardNo))
            {
            <tr>
                <td>@(++sl).</td>
                <td>
                    @Html.DisplayFor(modelItem => item.Name)
                </td>
                @if (ViewBag.attendanceFor == "Students")
                {
                    <td>@item.CardNo</td>
                    <td>@item.GuardianPhone</td>
                }
                else
                {
                    <td>@item.Designation</td>
                    <td>@item.Phone</td>
                }
                <td>
                    Attended
                </td>
                <td>
                    @string.Format("{0:hh:mm:ss tt}", item.PunchDateTime)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.UserInfo)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Remarks)
                </td>
                <td class="tableBody_last_td">
                    <partial name="_edit_details_delete" model="@item.Id" />
                </td>
            </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="row">
        <div class="col-md-12 text-center">
            <div class="jumbotron">
                <span>Data not found. To get data, search with type of user and date.</span>
            </div>
        </div>
    </div>
}

@section Scripts{
    <script src="~/js/DataTable/dataTable.js"></script>
    <script>
        $(document).ready(function () {
            $('#userTypeId').change(function () {
                let uType = $('#userTypeId option:selected').val();
                if (uType == 'e') {
                    $('.designationArea').css("display", "block");
                    $('.classArea').css("display", "none");
                    $('.sessionArea').css("display", "none");
                }
                if (uType == 's') {
                    $('.designationArea').css("display", "none");
                    $('.sessionArea').css("display", "block");
                    $('.classArea').css("display", "block");
                }
            });
        });
    </script>
}
