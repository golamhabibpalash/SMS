@model SMS.App.ViewModels.Students.StudentFeeAllocationVM

@{
    GlobalUI.PageTitle = "Student Fee Allocation";
    int sl = 0;
}

@section Styles{
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
}

<div class="row">
    <div class="col-md-8">
        @if (Model.StudentFeeAllocations != null && Model.StudentFeeAllocations.Count() > 0)
        {
            <table class="table table-striped table-bordered rounded">
                <thead class="bg-dark text-light">
                    <tr>
                        <td>#</td>
                        <td>Class Roll</td>
                        <td>Student</td>
                        <td>Fee Type</td>
                        <td class="text-right">Amount</td>
                        <td class="text-center">Documents</td>
                        <td class="text-center">Status</td>
                        <td class="text-center">Action</td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.StudentFeeAllocations)
                    {
                        <tr>
                            <td>@(++sl)</td>
                            <td>@item.Student.ClassRoll</td>
                            <td>@item.Student.Name</td>
                            <td>@item.StudentFeeHead.Name</td>
                            <td class="text-right">@item.AllocatedAmount</td>
                            <td class="text-center">
                                @if (string.IsNullOrEmpty(item.FeeAllocationApplication))
                                {
                                    <span>None</span>
                                }
                                else
                                {
                                    <span class="fas fa-file-pdf text-danger fa-2x " role="button"></span>
                                }
                            </td>
                            <td>
                                @if (item.IsActive)
                                {
                                    <span class="fas fa-check text-info fa-2x"></span>
                                }
                                else
                                {
                                    <span>None</span>
                                }
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
                                    <button type="button" class="btn btn-warning updateBtn" data-studentId="@item.StudentId" data-classId="@item.Student.AcademicClassId" data-amount="@item.AllocatedAmount" data-feeType="@item.StudentFeeHeadId" data-isActive="@item.IsActive" data-refDoc="@item.FeeAllocationApplication">Update</button>
                                    <button type="button" class="btn btn-danger">Delete</button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>

                </tfoot>
            </table>
        }
        else
        {
            <div class="jumbotron text-center mb-0">
                <h2>Data not found! <span class="fas fa-sad-tear text-warning"></span></h2><br />
            </div>
        }
    </div>
    <div class="col-md-4 p-2 rounded" style="background-color:antiquewhite">
        <fieldset class="border-primary p-2 border">
            <legend class="w-auto text-primary pb-0" id="create_update_title_id">Create New Allocation</legend>
            <form asp-action="Create" method="post">
                <div class="form-group row">
                    <label class="col-md-4 col-form-label">Academic Class</label>
                    <div class="col-md-8">
                        <select class="form-control" asp-items="Model.AcademicClassList" id="academicClassListId">
                            <option selected disabled>-Select Class-</option>
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-md-4 col-form-label">Student</label>
                    <div class="col-md-8">
                        <select class="form-control" asp-for="SFAllocation.StudentId">
                            <option selected disabled>-Select student-</option>
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-md-4 col-form-label">Fee Name</label>
                    <div class="col-md-8">
                        <select class="form-control" asp-for="SFAllocation.StudentFeeHeadId" asp-items="Model.FeeList">
                            <option selected disabled>-Select type-</option>
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-md-4 col-form-label">Allocate Amount</label>
                    <div class="col-md-8">
                        <input class="form-control" asp-for="SFAllocation.AllocatedAmount" />
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-md-4 col-form-label">Reference Docs</label>
                    <div class="col-md-8">
                        <input class="" type="file" asp-for="SFAllocation.FeeAllocationApplication" />
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-md-4 col-form-label">Is Active</label>
                    <div class="col-md-1 text-left">
                        <input class="form-control" asp-for="SFAllocation.IsActive" />
                    </div>
                    <div class="offset-md-5 col-md-2">
                        <input type="submit" value="Submit" class="btn btn-info btn-sm" />
                    </div>
                </div>
            </form>
        </fieldset>
    </div>

</div>

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $('#academicClassListId').change(function () {
            let classId = $('#academicClassListId option:selected').val();
            $.ajax({
                url: '/api/Students/getbyclasswithsessionId',
                data: { academicSessionId: null, academicClassId: classId },
                cache: false,
                type: 'POST',
                dataType: 'json',
                success: function (data) {
                    $.each(data, function (i, obj) {
                        console.log(obj.name);
                        var op = '<option value="' + obj.id + '">' + obj.classRoll + '-' + obj.name + '</option>';
                        $('#SFAllocation_StudentId').append(op);
                    });

                },
                error: function (err) {
                    console.log(err);
                }
            });


        });

        $(document).ready(function () {
            // Add a click event listener to the button
            $(".updateBtn").click(function () {
                // Retrieve the data property values
                var studentId = $(this).data("studentid");
                var classId = $(this).data("classid");
                var amount = $(this).data("amount");
                var feeType = $(this).data("feetype");
                var isActive = $(this).data("isactive");
                var refDoc = $(this).data("refdoc");

                $("#academicClassListId").val(classId).trigger('change');
                $("#academicClassListId").val(classId).trigger('change');

                console.log("Student ID:", studentId);
                console.log("Class ID:", classId);
                console.log("Amount:", amount);
                console.log("Fee Type:", feeType);
                console.log("Is Active:", isActive);
                console.log("Ref Doc:", refDoc);
            });
        });
    </script>
}